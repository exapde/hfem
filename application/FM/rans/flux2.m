function [f,f_udg] = flux2(pg,U,param,time)
% FLUX Volume flux function
%   [f,fu,fq] = flux(p,u,q,param)
% 
%      P(N,ND)              Coordinates for N points
%      U(N,NC)              Unknown vector for N points with NC components
%      Q(N,NC,ND)           Flux vector for N points with NC components in the
%                           coordinate directions
%      PARAM                Parameter list
%      F(N,NC,ND):          Volume flux at N points
%      FU(N,NC,ND,NC):      Jacobian of the flux flux vector w.r.t. U
%      FQ(N,NC,ND,NC,ND):   Jacobian of the flux flux vector w.r.t. Q

[ng,nc] = size(U);
nch  = nc/3;
zero = zeros(ng,1);
%one  = ones(ng,1);

gam  = param{1};
%gam1 = gam-1.0;
Re   = param{3};
%Re1  = 1/Re;
Pr   = param{4};
% Minf = param{5};
% M2   = Minf^2;

%c23  = 2/3;
cv1  = 7.1;
sigm = 2/3;
%fc   = 1/(gam1*M2*Re*Pr);


Fix(:,0+1) = U(:,1+1);
t1 = Fix(:,0+1).^0.2e1;
t2 = U(:,0+1);
t3 = 0.1e1 ./ t2;
t5 = gam - 0.1e1;
t6 = U(:,3+1);
t7 = U(:,2+1);
t8 = t7 .* t7;
t9 = t1 + t8;
t13 = t5 .* (t6 - t9 .* t3 ./ 0.2e1);
Fix(:,1+1) = t1 .* t3 + t13;
Fix(:,2+1) = Fix(:,0+1) .* t7 .* t3;
t15 = t6 + t13;
t16 = Fix(:,0+1) .* t15;
Fix(:,3+1) = t16 .* t3;
t17 = U(:,4+1);
t18 = t17 .* Fix(:,0+1);
Fix(:,4+1) = t18 .* t3;
Fiy(:,0+1) = t7;
Fiy(:,1+1) = Fix(:,2+1);
Fiy(:,2+1) = t8 .* t3 + t13;
t20 = Fiy(:,0+1) .* t15;
Fiy(:,3+1) = t20 .* t3;
t21 = t17 .* Fiy(:,0+1);
Fiy(:,4+1) = t21 .* t3;
Fvx(:,0+1) = zero;
t23 = U(:,5+1);
t24 = t23 .* Fix(:,0+1);
t26 = U(:,6+1) - t24 .* t3;
t27 = t26 .* t3;
t30 = U(:,10+1);
t31 = t30 .* Fiy(:,0+1);
t33 = U(:,12+1) - t31 .* t3;
t34 = t33 .* t3;
t36 = 0.4e1 ./ 0.3e1 .* t27 - 0.2e1 ./ 0.3e1 .* t34;
t37 = t17 .* t17;
t38 = t37 .* t37;
t39 = Re^0.2e1;
t40 = t39 .* Re;
t43 = t37 .* t17 .* t40;
t44 = cv1 .* cv1;
t46 = t43 + t44 .* cv1;
t47 = 0.1e1 ./ t46;
t50 = t38 .* t40 .* t47 + 0.1e1 ./ Re;
Fvx(:,1+1) = t36 .* t50;
t52 = t23 .* Fiy(:,0+1);
t54 = U(:,7+1) - t52 .* t3;
t57 = t30 .* Fix(:,0+1);
t59 = U(:,11+1) - t57 .* t3;
t61 = t54 .* t3 + t59 .* t3;
Fvx(:,2+1) = t61 .* t50;
t62 = t36 .* Fix(:,0+1);
t64 = t61 .* Fiy(:,0+1);
t67 = gam ./ Pr;
t69 = t23 .* t6;
t71 = U(:,8+1) - t69 .* t3;
t73 = t2 .* t2;
t74 = 0.1e1 ./ t73;
t75 = Fix(:,0+1) .* t74;
t77 = Fiy(:,0+1) .* t74;
t81 = t62 .* t3 + t64 .* t3 + t67 .* (t71 .* t3 - t75 .* t26 - t77 .* t54);
Fvx(:,3+1) = t81 .* t50;
t82 = 0.1e1 ./ sigm;
t83 = t50 .* t82;
t85 = t23 .* t17;
t87 = U(:,9+1) - t85 .* t3;
t88 = t87 .* t3;
Fvx(:,4+1) = t83 .* t88;
Fvy(:,0+1) = zero;
Fvy(:,1+1) = Fvx(:,2+1);
t91 = 0.4e1 ./ 0.3e1 .* t34 - 0.2e1 ./ 0.3e1 .* t27;
Fvy(:,2+1) = t91 .* t50;
t92 = t61 .* Fix(:,0+1);
t94 = t91 .* Fiy(:,0+1);
t97 = t30 .* t6;
t99 = U(:,13+1) - t97 .* t3;
t105 = t92 .* t3 + t94 .* t3 + t67 .* (t99 .* t3 - t75 .* t59 - t77 .* t33);
Fvy(:,3+1) = t105 .* t50;
t107 = t30 .* t17;
t109 = U(:,14+1) - t107 .* t3;
t110 = t109 .* t3;
Fvy(:,4+1) = t83 .* t110;

Jix(:,0+1) = zero;
t114 = t5 .* t9 .* t74 ./ 0.2e1;
Jix(:,1+1) = -t1 .* t74 + t114;
Jix(:,2+1) = -Fix(:,0+1) .* Fiy(:,0+1) .* t74;
t117 = Fix(:,0+1) .* t5;
t119 = 0.1e1 ./ t73 ./ t2;
t120 = t9 .* t119;
Jix(:,3+1) = t117 .* t120 ./ 0.2e1 - t16 .* t74;
Jix(:,4+1) = -t18 .* t74;
Jix(:,5+1) = 0.1e1;
t125 = Fix(:,0+1) .* t3;
t127 = t117 .* t3;
Jix(:,6+1) = 0.2e1 .* t125 - t127;
Jix(:,7+1) = Fiy(:,0+1) .* t3;
t128 = t15 .* t3;
Jix(:,8+1) = t128 - t1 .* t5 .* t74;
Jix(:,9+1) = t17 .* t3;
Jix(:,10+1) = zero;
Jix(:,11+1) = -t5 .* Fiy(:,0+1) .* t3;
Jix(:,12+1) = t125;
Jix(:,13+1) = -t117 .* t77;
Jix(:,14+1) = zero;
Jix(:,15+1) = zero;
Jix(:,16+1) = t5;
Jix(:,17+1) = zero;
Jix(:,18+1) = Fix(:,0+1) .* gam .* t3;
Jix(:,19+1) = zero;
Jix(:,20+1) = zero;
Jix(:,21+1) = zero;
Jix(:,22+1) = zero;
Jix(:,23+1) = zero;
Jix(:,24+1) = Jix(:,12+1);

Jiy(:,0+1) = zero;
Jiy(:,1+1) = Jix(:,2+1);
Jiy(:,2+1) = -t8 .* t74 + t114;
Jiy(:,3+1) = Fiy(:,0+1) .* Jix(:,16+1) .* t120 ./ 0.2e1 - t20 .* t74;
Jiy(:,4+1) = -t21 .* t74;
Jiy(:,5+1) = zero;
Jiy(:,6+1) = Jix(:,7+1);
Jiy(:,7+1) = -t127;
Jiy(:,8+1) = Jix(:,13+1);
Jiy(:,9+1) = zero;
Jiy(:,10+1) = 0.1e1;
Jiy(:,11+1) = Jix(:,24+1);
Jiy(:,12+1) = 0.2e1 .* Jiy(:,6+1) + Jix(:,11+1);
Jiy(:,13+1) = t128 - t8 .* Jix(:,16+1) .* t74;
Jiy(:,14+1) = Jix(:,9+1);
Jiy(:,15+1) = zero;
Jiy(:,16+1) = zero;
Jiy(:,17+1) = Jix(:,16+1);
Jiy(:,18+1) = Fiy(:,0+1) .* gam .* t3;
Jiy(:,19+1) = zero;
Jiy(:,20+1) = zero;
Jiy(:,21+1) = zero;
Jiy(:,22+1) = zero;
Jiy(:,23+1) = zero;
Jiy(:,24+1) = Jiy(:,6+1);

Jvx(:,0+1) = zero;
t145 = t24 .* t119;
t146 = 0.4e1 ./ 0.3e1 .* t145;
t147 = t26 .* t74;
t149 = t31 .* t119;
t151 = t33 .* t74;
t153 = t146 - 0.4e1 ./ 0.3e1 .* t147 - 0.2e1 ./ 0.3e1 .* t149 + 0.2e1 ./ 0.3e1 .* t151;
Jvx(:,1+1) = t153 .* t50;
t154 = t52 .* t119;
t155 = t54 .* t74;
t156 = t57 .* t119;
t157 = t59 .* t74;
t158 = t154 - t155 + t156 - t157;
Jvx(:,2+1) = t158 .* t50;
t167 = Fix(:,0+1) .* t119;
t170 = t73 .* t73;
t171 = 0.1e1 ./ t170;
t172 = t1 .* t171;
t174 = Fiy(:,0+1) .* t119;
t177 = t8 .* t171;
Jvx(:,3+1) = (t153 .* Fix(:,0+1) .* t3 - t62 .* t74 + t158 .* Fiy(:,0+1) .* t3 - t64 .* t74 + t67 .* (t69 .* t119 - t71 .* t74 + 0.2e1 .* t167 .* t26 - t172 .* t23 + 0.2e1 .* t174 .* t54 - t177 .* t23)) .* t50;
Jvx(:,4+1) = t83 .* t85 .* t119 - t83 .* t87 .* t74;
Jvx(:,5+1) = zero;
t186 = t23 .* t74;
t187 = t186 .* t50;
Jvx(:,6+1) = -0.4e1 ./ 0.3e1 .* t187;
t189 = t30 .* t74;
t190 = t189 .* t50;
Jvx(:,7+1) = -t190;
Jvx(:,8+1) = (-t146 + t36 .* t3 - t149 + t67 .* (t145 - t147)) .* t50;
Jvx(:,9+1) = zero;
Jvx(:,10+1) = zero;
Jvx(:,11+1) = 0.2e1 ./ 0.3e1 .* t190;
Jvx(:,12+1) = -t187;
t196 = t61 .* t3;
Jvx(:,13+1) = (0.2e1 ./ 0.3e1 .* t156 - t154 + t196 + t67 .* (t154 - t155)) .* t50;
Jvx(:,14+1) = zero;
Jvx(:,15+1) = zero;
Jvx(:,16+1) = zero;
Jvx(:,17+1) = zero;
Jvx(:,18+1) = -t67 .* t187;
Jvx(:,19+1) = zero;
Jvx(:,20+1) = zero;
t204 = t39 .* t39;
t207 = t46 .* t46;
t211 = 0.4e1 .* t43 .* t47 - 0.3e1 .* t38 .* t37 .* t204 .* t39 ./ t207;
Jvx(:,21+1) = t36 .* t211;
Jvx(:,22+1) = t61 .* t211;
Jvx(:,23+1) = t81 .* t211;
t212 = t211 .* t82;
Jvx(:,24+1) = t212 .* t88 - t83 .* t186;
Jvx(:,25+1) = zero;
t215 = t75 .* t50;
Jvx(:,26+1) = -0.4e1 ./ 0.3e1 .* t215;
t217 = t77 .* t50;
Jvx(:,27+1) = -t217;
t218 = t1 .* t119;
t220 = t8 .* t119;
t223 = t67 .* (-t6 .* t74 + t218 + t220);
Jvx(:,28+1) = (-0.4e1 ./ 0.3e1 .* t218 - t220 + t223) .* t50;
Jvx(:,29+1) = -t83 .* t17 .* t74;
Jvx(:,30+1) = zero;
t227 = t3 .* t50;
Jvx(:,31+1) = 0.4e1 ./ 0.3e1 .* t227;
Jvx(:,32+1) = zero;
t229 = t67 .* t75;
Jvx(:,33+1) = (0.4e1 ./ 0.3e1 .* t75 - t229) .* t50;
Jvx(:,34+1) = zero;
Jvx(:,35+1) = zero;
Jvx(:,36+1) = zero;
Jvx(:,37+1) = t227;
t231 = t67 .* t77;
Jvx(:,38+1) = (t77 - t231) .* t50;
Jvx(:,39+1) = zero;
Jvx(:,40+1) = zero;
Jvx(:,41+1) = zero;
Jvx(:,42+1) = zero;
Jvx(:,43+1) = t67 .* Jvx(:,37+1);
Jvx(:,44+1) = zero;
Jvx(:,45+1) = zero;
Jvx(:,46+1) = zero;
Jvx(:,47+1) = zero;
Jvx(:,48+1) = zero;
Jvx(:,49+1) = t83 .* t3;
Jvx(:,50+1) = zero;
Jvx(:,51+1) = 0.2e1 ./ 0.3e1 .* t217;
Jvx(:,52+1) = -t215;
Jvx(:,53+1) = -t174 .* Fix(:,0+1) .* t50 ./ 0.3e1;
Jvx(:,54+1) = zero;
Jvx(:,55+1) = zero;
Jvx(:,56+1) = zero;
Jvx(:,57+1) = Jvx(:,37+1);
Jvx(:,58+1) = t217;
Jvx(:,59+1) = zero;
Jvx(:,60+1) = zero;
Jvx(:,61+1) = -0.2e1 ./ 0.3e1 .* Jvx(:,57+1);
Jvx(:,62+1) = zero;
t237 = 0.2e1 ./ 0.3e1 .* t215;
Jvx(:,63+1) = -t237;
Jvx(:,64+1) = zero;
Jvx(:,65+1) = zero;
Jvx(:,66+1) = zero;
Jvx(:,67+1) = zero;
Jvx(:,68+1) = zero;
Jvx(:,69+1) = zero;
Jvx(:,70+1) = zero;
Jvx(:,71+1) = zero;
Jvx(:,72+1) = zero;
Jvx(:,73+1) = zero;
Jvx(:,74+1) = zero;
Jvy(:,0+1) = zero;
Jvy(:,1+1) = Jvx(:,2+1);
t238 = 0.4e1 ./ 0.3e1 .* t149;
t242 = t238 - 0.4e1 ./ 0.3e1 .* t151 - 0.2e1 ./ 0.3e1 .* t145 + 0.2e1 ./ 0.3e1 .* t147;
Jvy(:,2+1) = t242 .* t50;
Jvy(:,3+1) = (t158 .* Fix(:,0+1) .* t3 - t92 .* t74 + t242 .* Fiy(:,0+1) .* t3 - t94 .* t74 + t67 .* (t97 .* t119 - t99 .* t74 + 0.2e1 .* t167 .* t59 - t172 .* t30 + 0.2e1 .* t174 .* t33 - t177 .* t30)) .* t50;
Jvy(:,4+1) = t83 .* t107 .* t119 - t83 .* t109 .* t74;
Jvy(:,5+1) = zero;
Jvy(:,6+1) = Jvx(:,7+1);
Jvy(:,7+1) = 0.2e1 ./ 0.3e1 .* t187;
Jvy(:,8+1) = (-t156 + t196 + 0.2e1 ./ 0.3e1 .* t154 + t67 .* (t156 - t157)) .* t50;
Jvy(:,9+1) = zero;
Jvy(:,10+1) = zero;
Jvy(:,11+1) = Jvx(:,12+1);
Jvy(:,12+1) = -0.4e1 ./ 0.3e1 .* t190;
Jvy(:,13+1) = (-t145 - t238 + t91 .* t3 + t67 .* (t149 - t151)) .* t50;
Jvy(:,14+1) = zero;
Jvy(:,15+1) = zero;
Jvy(:,16+1) = zero;
Jvy(:,17+1) = zero;
Jvy(:,18+1) = -t67 .* t190;
Jvy(:,19+1) = zero;
Jvy(:,20+1) = zero;
Jvy(:,21+1) = Jvx(:,22+1);
Jvy(:,22+1) = t91 .* t211;
Jvy(:,23+1) = t105 .* t211;
Jvy(:,24+1) = t212 .* t110 - t83 .* t189;
Jvy(:,25+1) = zero;
Jvy(:,26+1) = Jvx(:,27+1);
Jvy(:,27+1) = t237;
Jvy(:,28+1) = Jvx(:,53+1);
Jvy(:,29+1) = zero;
Jvy(:,30+1) = zero;
Jvy(:,31+1) = zero;
Jvy(:,32+1) = Jvx(:,61+1);
Jvy(:,33+1) = -Jvx(:,51+1);
Jvy(:,34+1) = zero;
Jvy(:,35+1) = zero;
Jvy(:,36+1) = Jvx(:,57+1);
Jvy(:,37+1) = zero;
Jvy(:,38+1) = t215;
Jvy(:,39+1) = zero;
Jvy(:,40+1) = zero;
Jvy(:,41+1) = zero;
Jvy(:,42+1) = zero;
Jvy(:,43+1) = zero;
Jvy(:,44+1) = zero;
Jvy(:,45+1) = zero;
Jvy(:,46+1) = zero;
Jvy(:,47+1) = zero;
Jvy(:,48+1) = zero;
Jvy(:,49+1) = zero;
Jvy(:,50+1) = zero;
Jvy(:,51+1) = Jvx(:,52+1);
Jvy(:,52+1) = -0.4e1 ./ 0.3e1 .* Jvx(:,58+1);
Jvy(:,53+1) = (-t218 - 0.4e1 ./ 0.3e1 .* t220 + t223) .* t50;
Jvy(:,54+1) = Jvx(:,29+1);
Jvy(:,55+1) = zero;
Jvy(:,56+1) = Jvy(:,36+1);
Jvy(:,57+1) = zero;
Jvy(:,58+1) = (t75 - t229) .* t50;
Jvy(:,59+1) = zero;
Jvy(:,60+1) = zero;
Jvy(:,61+1) = zero;
Jvy(:,62+1) = Jvx(:,31+1);
Jvy(:,63+1) = (0.4e1 ./ 0.3e1 .* t77 - t231) .* t50;
Jvy(:,64+1) = zero;
Jvy(:,65+1) = zero;
Jvy(:,66+1) = zero;
Jvy(:,67+1) = zero;
Jvy(:,68+1) = Jvx(:,43+1);
Jvy(:,69+1) = zero;
Jvy(:,70+1) = zero;
Jvy(:,71+1) = zero;
Jvy(:,72+1) = zero;
Jvy(:,73+1) = zero;
Jvy(:,74+1) = Jvx(:,49+1);


f = zeros(ng,nch,2);
f(:,:,1) = Fix + Fvx;
f(:,:,2) = Fiy + Fvy;

fi_u = zeros(ng,nch,2,nch);
fv_u = zeros(ng,nch,2,nch);
fv_q = zeros(ng,nch,2,nch,2);

fi_u(:,:,1,:) = reshape(Jix,[ng nch nch]);
fi_u(:,:,2,:) = reshape(Jiy,[ng nch nch]);
fv_u(:,:,1,:) = reshape(Jvx(:,1:nch*nch),[ng nch nch]);
fv_u(:,:,2,:) = reshape(Jvy(:,1:nch*nch),[ng nch nch]);

fv_q(:,:,1,:,:) = reshape(Jvx(:,nch*nch+1:end),[ng nch nch 2]);
fv_q(:,:,2,:,:) = reshape(Jvy(:,nch*nch+1:end),[ng nch nch 2]);

f_udg = cat(4,fi_u+fv_u,reshape(fv_q,ng,nch,2,2.*nch));









