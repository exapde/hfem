
#define PI (3.141592653589793)

// Written by: C. Nguyen & P. Fernandez

void source_ransSA3dNEW(double *s, double *s_udg, double *pg, double *udg, appstruct &app, double *param,
                        double time, int ng, int nc, int ncu, int nd, int ncd, int computeJacobian)
{
    double param1 = param[0];
    double param2 = param[1];
    double param3 = param[2];
    double param4 = param[3];
    double param5 = param[4];
    double param6 = param[5];

    /* Allocate dynamic memory */
    double * mu  = new double [ng];
    double * mu_udg;
    double * s_mu;
    if (computeJacobian == 1 && app.viscosityModel != 0) {
        mu_udg = new double [ng * nc];
        s_mu = new double [ng * ncu];
    }

    // Closure parameters of SA model:
    double rMax = 5.0;     // rMax in [5,10] is typically used.
    double cv1 = 7.1;
    double sigma = 2.0/3.0;
    double cb1 = 0.1355;
    double cb2 = 0.622;
    double kappa = 0.41;
    double cw1 = cb1/(kappa*kappa) + (1+cb2)/sigma;
    double cw2 = 0.3;
    double cw3 = 2.0;
    double ct1 = 1.0;      // From David's paper
    double ct2 = 2.0;      // From David's paper
    double ct3 = 1.2;      // From NASA Langley webpage (ct3 = 1.1 from David's paper)
    double ct4 = 0.5;      // From NASA Langley webpage (ct4 = 2.0 from David's paper)

    // SA regularization parameters (Ref. Hemant Chaurasia PhD Thesis):
    double b = 100.0;
    double c = 1.0/2.0 - atan(b)/PI;

    // No laminar suppression and forced transition are considered:
    double deltaU = 0;
    double ft1 = 0;             // ft1 = ct1*gt*exp(-ct2*(wt*wt/(deltaU*deltaU))*(walDistance*wallDistance+gt*gt*dt*dt))
    double ft2 = 0;             // ft2 = ct3*exp(-ct4*psi [or chi])

    getViscosity(mu, mu_udg, pg, udg, param, app.viscosityModel, ng, nc, ncu, nd, computeJacobian);

    for (int i = 0; i <ng; i++) {
        double x1 = pg[0*ng+i];
        double x2 = pg[1*ng+i];
        double x3 = pg[2*ng+i];

        double wallDistance = pg[4*ng+i];

        double u1 = udg[0*ng+i];
        double u2 = udg[1*ng+i];
        double u3 = udg[2*ng+i];
        double u4 = udg[3*ng+i];
        double u5 = udg[4*ng+i];
        double u6 = udg[5*ng+i];
        double u7 = udg[6*ng+i];
        double u8 = udg[7*ng+i];
        double u9 = udg[8*ng+i];
        double u10 = udg[9*ng+i];
        double u11 = udg[10*ng+i];
        double u12 = udg[11*ng+i];
        double u13 = udg[12*ng+i];
        double u14 = udg[13*ng+i];
        double u15 = udg[14*ng+i];
        double u16 = udg[15*ng+i];
        double u17 = udg[16*ng+i];
        double u18 = udg[17*ng+i];
        double u19 = udg[18*ng+i];
        double u20 = udg[19*ng+i];
        double u21 = udg[20*ng+i];
        double u22 = udg[21*ng+i];
        double u23 = udg[22*ng+i];
        double u24 = udg[23*ng+i];

        double t4 = 1.0/u1;
        double t52 = t4*u6*u7;
        double t2 = -t52+u12;
        double t3 = 1.0/(u1*u1);
        double t53 = t4*u6*u13;
        double t5 = -t53+u18;
        double t54 = t4*u6*u19;
        double t6 = -t54+u24;
        double t7 = 1.0/mu[i];
        double t11 = t4*u3*u7;
        double t12 = t11-u9;
        double t13 = t4*t12;
        double t14 = t4*u2*u13;
        double t15 = t4*(t14-u14);
        double t8 = -t13+t15;
        double t17 = t4*u4*u7;
        double t18 = t17-u10;
        double t19 = t4*t18;
        double t20 = t4*u2*u19;
        double t21 = t4*(t20-u20);
        double t9 = -t19+t21;
        double t23 = t4*u4*u13;
        double t24 = t23-u16;
        double t25 = t4*t24;
        double t26 = t4*u3*u19;
        double t27 = t4*(t26-u21);
        double t10 = -t25+t27;
        double t16 = t8*t8;
        double t22 = t9*t9;
        double t28 = t10*t10;
        double t29 = t16+t22+t28+1.0E-20;
        double t30 = sqrt(t29);
        double t31 = 1.0/param3;
        double t32 = 1.0/3.141592653589793;
        double t33 = b*t7*u6;
        double t34 = atan(t33);
        double t35 = t32*t34;
        double t36 = t35+1.0/2.0;
        double t37 = t7*t36*u6;
        double t38 = c+t37;
        double t39 = t38*t38;
        double t40 = cv1*cv1;
        double t41 = 1.0/(kappa*kappa);
        double t42 = 1.0/(wallDistance*wallDistance);
        double t43 = t39*t39;
        double t44 = cv1*t40+t38*t39;
        double t45 = 1.0/t44;
        double t46 = t43*t45;
        double t47 = t46+1.0;
        double t48 = 1.0/t47;
        double t49 = t38*t48;
        double t50 = t49-1.0;
        double t51 = 1.0/sigma;
        double t55 = cw3*cw3;
        double t56 = t55*t55;
        double t57 = c*t30;
        double t58 = t30*(1.0/1.0E1);
        double t59 = t30*(9.0/1.0E1);
        double t69 = mu[i]*t4*t31*t38*t41*t42*t50;
        double t60 = t59-t69;
        double t61 = 1.0/sqrt(t29);
        double t62 = mu[i]*t4*t31*t38*t41*t42*t50*t61;
        double t63 = t62-9.0/1.0E1;
        double t64 = b*t63;
        double t65 = atan(t64);
        double t66 = t32*t65;
        double t67 = t66-1.0/2.0;
        double t70 = t60*t67;
        double t68 = t57+t58-t70;
        double t71 = 1.0/t68;
        double t73 = mu[i]*t4*t31*t38*t41*t42*t71;
        double t72 = rMax-t73;
        double t74 = b*t72;
        double t75 = atan(t74);
        double t76 = t32*t75;
        double t77 = t76+1.0/2.0;
        double t78 = t72*t77;
        double t79 = c-rMax+t78;
        double t80 = t79*t79;
        double t81 = t80*t80;
        double t85 = c-rMax+t78+t80*t81;
        double t86 = cw2*t85;
        double t82 = c-rMax+t78-t86;
        double t83 = t82*t82;
        double t84 = t83*t83;

        s[0*ng+i] = 0.0;
        s[1*ng+i] = 0.0;
        s[2*ng+i] = 0.0;
        s[3*ng+i] = 0.0;
        s[4*ng+i] = 0.0;
        s[5*ng+i] = (deltaU*deltaU)*ft1*param3*u1+cb2*t31*t51*u1*((t2*t2)*t3+t3*(t5*t5)+t3*(t6*t6))-cb1*mu[i]*t38*t68*(ft2-1.0)+(mu[i]*mu[i])*t4*t31*t39*t42*(cb1*ft2*t41+cw1*t82*pow((t55*t56+1.0)/(t55*t56+t83*t84),1.0/6.0))-mu[i]*t4*t31*t51*(c+t37+1.0)*(t2*t4*u7+t4*t5*u13+t4*t6*u19);
    }
    
//     for (int i = 0; i <ng*6; i++) {
//         s[i] /= param3;
//     }

    if (computeJacobian == 1) {

        for (int i = 0; i <ng; i++) {
            double x1 = pg[0*ng+i];
            double x2 = pg[1*ng+i];
            double x3 = pg[2*ng+i];

            double wallDistance = pg[4*ng+i];

            double u1 = udg[0*ng+i];
            double u2 = udg[1*ng+i];
            double u3 = udg[2*ng+i];
            double u4 = udg[3*ng+i];
            double u5 = udg[4*ng+i];
            double u6 = udg[5*ng+i];
            double u7 = udg[6*ng+i];
            double u8 = udg[7*ng+i];
            double u9 = udg[8*ng+i];
            double u10 = udg[9*ng+i];
            double u11 = udg[10*ng+i];
            double u12 = udg[11*ng+i];
            double u13 = udg[12*ng+i];
            double u14 = udg[13*ng+i];
            double u15 = udg[14*ng+i];
            double u16 = udg[15*ng+i];
            double u17 = udg[16*ng+i];
            double u18 = udg[17*ng+i];
            double u19 = udg[18*ng+i];
            double u20 = udg[19*ng+i];
            double u21 = udg[20*ng+i];
            double u22 = udg[21*ng+i];
            double u23 = udg[22*ng+i];
            double u24 = udg[23*ng+i];

            double t4 = 1.0/u1;
            double t77 = t4*u6*u7;
            double t2 = -t77+u12;
            double t3 = 1.0/(u1*u1);
            double t79 = t4*u6*u13;
            double t5 = -t79+u18;
            double t81 = t4*u6*u19;
            double t6 = -t81+u24;
            double t7 = 1.0/mu[i];
            double t15 = t4*u3*u7;
            double t8 = -t15+u9;
            double t17 = t4*u2*u13;
            double t9 = -t17+u14;
            double t10 = 1.0/(u1*u1*u1);
            double t19 = t4*u4*u7;
            double t11 = -t19+u10;
            double t21 = t4*u2*u19;
            double t12 = -t21+u20;
            double t23 = t4*u4*u13;
            double t13 = -t23+u16;
            double t25 = t4*u3*u19;
            double t14 = -t25+u21;
            double t16 = t4*t8;
            double t37 = t4*t9;
            double t18 = t16-t37;
            double t20 = t4*t11;
            double t39 = t4*t12;
            double t22 = t20-t39;
            double t24 = t4*t13;
            double t41 = t4*t14;
            double t26 = t24-t41;
            double t27 = 1.0/3.141592653589793;
            double t28 = 1.0/param3;
            double t29 = b*t7*u6;
            double t30 = atan(t29);
            double t31 = t27*t30;
            double t32 = t31+1.0/2.0;
            double t33 = t7*t32*u6;
            double t34 = c+t33;
            double t35 = t34*t34;
            double t36 = cv1*cv1;
            double t38 = t18*t18;
            double t40 = t22*t22;
            double t42 = t26*t26;
            double t43 = t38+t40+t42+1.0E-20;
            double t44 = 1.0/sqrt(t43);
            double t45 = t3*t8;
            double t46 = t10*u2*u13;
            double t68 = t3*t9;
            double t69 = t10*u3*u7;
            double t47 = t45+t46-t68-t69;
            double t48 = t18*t47*2.0;
            double t49 = t3*t11;
            double t50 = t10*u2*u19;
            double t70 = t3*t12;
            double t71 = t10*u4*u7;
            double t51 = t49+t50-t70-t71;
            double t52 = t22*t51*2.0;
            double t53 = t3*t13;
            double t54 = t10*u3*u19;
            double t72 = t3*t14;
            double t73 = t10*u4*u13;
            double t55 = t53+t54-t72-t73;
            double t56 = t26*t55*2.0;
            double t57 = t48+t52+t56;
            double t58 = 1.0/(kappa*kappa);
            double t59 = 1.0/(wallDistance*wallDistance);
            double t60 = t35*t35;
            double t61 = cv1*t36+t34*t35;
            double t62 = 1.0/t61;
            double t63 = t60*t62;
            double t64 = t63+1.0;
            double t65 = 1.0/t64;
            double t66 = t34*t65;
            double t67 = t66-1.0;
            double t74 = mu[i]*t4*t28*t34*t44*t58*t59*t67;
            double t75 = t74-9.0/1.0E1;
            double t76 = 1.0/sigma;
            double t78 = t2*t2;
            double t80 = t5*t5;
            double t82 = t6*t6;
            double t83 = 1.0/(u1*u1*u1*u1);
            double t84 = cw3*cw3;
            double t85 = t84*t84;
            double t86 = sqrt(t43);
            double t87 = t86*(9.0/1.0E1);
            double t95 = mu[i]*t4*t28*t34*t58*t59*t67;
            double t88 = t87-t95;
            double t89 = b*t75;
            double t90 = atan(t89);
            double t91 = t27*t90;
            double t92 = t91-1.0/2.0;
            double t93 = c*t86;
            double t94 = t86*(1.0/1.0E1);
            double t99 = t88*t92;
            double t96 = t93+t94-t99;
            double t97 = 1.0/t96;
            double t100 = mu[i]*t4*t28*t34*t58*t59*t97;
            double t98 = rMax-t100;
            double t101 = b*t98;
            double t102 = atan(t101);
            double t103 = t27*t102;
            double t104 = t103+1.0/2.0;
            double t105 = t98*t104;
            double t106 = c-rMax+t105;
            double t107 = t106*t106;
            double t108 = t107*t107;
            double t140 = c-rMax+t105+t107*t108;
            double t141 = cw2*t140;
            double t109 = c-rMax+t105-t141;
            double t110 = t109*t109;
            double t111 = t110*t110;
            double t112 = t44*t57*(1.0/2.0E1);
            double t113 = t44*t57*(9.0/2.0E1);
            double t127 = mu[i]*t3*t28*t34*t58*t59*t67;
            double t114 = t113-t127;
            double t115 = c*t44*t57*(1.0/2.0);
            double t116 = mu[i]*t3*t28*t34*t44*t58*t59*t67;
            double t117 = 1.0/pow(t43,3.0/2.0);
            double t129 = mu[i]*t4*t28*t34*t57*t58*t59*t67*t117*(1.0/2.0);
            double t118 = t116-t129;
            double t119 = b*b;
            double t120 = t75*t75;
            double t121 = t119*t120;
            double t122 = t121+1.0;
            double t123 = 1.0/t122;
            double t128 = t92*t114;
            double t130 = b*t27*t88*t118*t123;
            double t124 = t112+t115-t128-t130;
            double t125 = mu[i]*t3*t28*t34*t58*t59*t97;
            double t126 = 1.0/(t96*t96);
            double t133 = mu[i]*t4*t28*t34*t58*t59*t124*t126;
            double t131 = t125-t133;
            double t132 = t104*t131;
            double t134 = t98*t98;
            double t135 = t119*t134;
            double t136 = t135+1.0;
            double t137 = 1.0/t136;
            double t138 = b*t27*t98*t131*t137;
            double t139 = t84*t85+1.0;
            double t142 = t84*t85+t110*t111;
            double t143 = 1.0/t142;
            double t144 = t139*t143;
            double t145 = t132+t138;
            double t146 = t106*t108*t145*6.0;
            double t147 = t132+t138+t146;
            double t148 = t132+t138-cw2*t147;
            double t149 = c+t33+1.0;
            double t150 = mu[i]*mu[i];
            double t151 = pow(t144,1.0/6.0);
            double t152 = ft2-1.0;
            double t153 = t3*t18*u13*2.0;
            double t154 = t3*t22*u19*2.0;
            double t155 = t153+t154;
            double t156 = t44*t155*(1.0/2.0E1);
            double t157 = c*t44*t155*(1.0/2.0);
            double t158 = b*mu[i]*t4*t27*t28*t34*t58*t59*t67*t88*t117*t123*t155*(1.0/2.0);
            double t160 = t44*t92*t155*(9.0/2.0E1);
            double t159 = t156+t157+t158-t160;
            double t161 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t159;
            double t162 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t159;
            double t163 = 1.0/pow(t144,5.0/6.0);
            double t164 = 1.0/(t142*t142);
            double t165 = t161+t162;
            double t166 = t106*t108*t165*6.0;
            double t167 = t161+t162+t166;
            double t168 = t161+t162-cw2*t167;
            double t169 = t3*t18*u7*2.0;
            double t171 = t3*t26*u19*2.0;
            double t170 = t169-t171;
            double t172 = t44*t170*(1.0/2.0E1);
            double t173 = c*t44*t170*(1.0/2.0);
            double t174 = b*mu[i]*t4*t27*t28*t34*t58*t59*t67*t88*t117*t123*t170*(1.0/2.0);
            double t176 = t44*t92*t170*(9.0/2.0E1);
            double t175 = t172+t173+t174-t176;
            double t177 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t175;
            double t178 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t175;
            double t179 = t177+t178;
            double t180 = t106*t108*t179*6.0;
            double t181 = t177+t178+t180;
            double t182 = t177+t178-cw2*t181;
            double t183 = t3*t22*u7*2.0;
            double t184 = t3*t26*u13*2.0;
            double t185 = t183+t184;
            double t186 = t44*t185*(1.0/2.0E1);
            double t187 = c*t44*t185*(1.0/2.0);
            double t188 = b*mu[i]*t4*t27*t28*t34*t58*t59*t67*t88*t117*t123*t185*(1.0/2.0);
            double t190 = t44*t92*t185*(9.0/2.0E1);
            double t189 = t186+t187+t188-t190;
            double t191 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t189;
            double t192 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t189;
            double t193 = t191+t192;
            double t194 = t106*t108*t193*6.0;
            double t195 = t191+t192+t194;
            double t196 = t191+t192-cw2*t195;
            double t197 = 1.0/(mu[i]*mu[i]);
            double t198 = t7*t32;
            double t199 = u6*u6;
            double t200 = t119*t197*t199;
            double t201 = t200+1.0;
            double t202 = 1.0/t201;
            double t203 = b*t27*t197*t202*u6;
            double t204 = t198+t203;
            double t205 = t65*t204;
            double t206 = 1.0/(t64*t64);
            double t207 = t34*t35*t62*t204*4.0;
            double t208 = 1.0/(t61*t61);
            double t216 = t35*t60*t204*t208*3.0;
            double t209 = t207-t216;
            double t217 = t34*t206*t209;
            double t210 = t205-t217;
            double t211 = t2*t4*u7;
            double t212 = t4*t5*u13;
            double t213 = t4*t6*u19;
            double t214 = t211+t212+t213;
            double t215 = mu[i]*t4*t28*t58*t59*t67*t204;
            double t218 = mu[i]*t4*t28*t34*t58*t59*t210;
            double t219 = t215+t218;
            double t220 = t92*t219;
            double t221 = mu[i]*t4*t28*t44*t58*t59*t67*t204;
            double t222 = mu[i]*t4*t28*t34*t44*t58*t59*t210;
            double t223 = t221+t222;
            double t226 = b*t27*t88*t123*t223;
            double t224 = t220-t226;
            double t225 = mu[i]*t4*t28*t58*t59*t97*t204;
            double t229 = mu[i]*t4*t28*t34*t58*t59*t126*t224;
            double t227 = t225-t229;
            double t228 = t104*t227;
            double t230 = b*t27*t98*t137*t227;
            double t231 = t228+t230;
            double t232 = t106*t108*t231*6.0;
            double t233 = t228+t230+t232;
            double t234 = t228+t230-cw2*t233;
            double t235 = u7*u7;
            double t236 = u13*u13;
            double t237 = u19*u19;
            double t238 = cw1*t109*t151;
            double t239 = cb1*ft2*t58;
            double t240 = t238+t239;
            double t241 = t3*t18*u3*2.0;
            double t242 = t3*t22*u4*2.0;
            double t243 = t241+t242;
            double t244 = t44*t243*(1.0/2.0E1);
            double t245 = c*t44*t243*(1.0/2.0);
            double t246 = b*mu[i]*t4*t27*t28*t34*t58*t59*t67*t88*t117*t123*t243*(1.0/2.0);
            double t248 = t44*t92*t243*(9.0/2.0E1);
            double t247 = t244+t245+t246-t248;
            double t249 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t247;
            double t250 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t247;
            double t251 = t249+t250;
            double t252 = t106*t108*t251*6.0;
            double t253 = t249+t250+t252;
            double t254 = t249+t250-cw2*t253;
            double t255 = t4*t18*t44*(1.0/1.0E1);
            double t256 = c*t4*t18*t44;
            double t257 = b*mu[i]*t3*t18*t27*t28*t34*t58*t59*t67*t88*t117*t123;
            double t259 = t4*t18*t44*t92*(9.0/1.0E1);
            double t258 = t255+t256+t257-t259;
            double t260 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t258;
            double t261 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t258;
            double t262 = t260+t261;
            double t263 = t106*t108*t262*6.0;
            double t264 = t260+t261+t263;
            double t291 = cw2*t264;
            double t265 = t260+t261-t291;
            double t266 = t4*t22*t44*(1.0/1.0E1);
            double t267 = c*t4*t22*t44;
            double t268 = b*mu[i]*t3*t22*t27*t28*t34*t58*t59*t67*t88*t117*t123;
            double t270 = t4*t22*t44*t92*(9.0/1.0E1);
            double t269 = t266+t267+t268-t270;
            double t271 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t269;
            double t272 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t269;
            double t273 = t271+t272;
            double t274 = t106*t108*t273*6.0;
            double t275 = t271+t272+t274;
            double t320 = cw2*t275;
            double t276 = t271+t272-t320;
            double t277 = t3*t18*u2*2.0;
            double t279 = t3*t26*u4*2.0;
            double t278 = t277-t279;
            double t280 = t44*t278*(1.0/2.0E1);
            double t281 = c*t44*t278*(1.0/2.0);
            double t282 = b*mu[i]*t4*t27*t28*t34*t58*t59*t67*t88*t117*t123*t278*(1.0/2.0);
            double t284 = t44*t92*t278*(9.0/2.0E1);
            double t283 = t280+t281+t282-t284;
            double t285 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t283;
            double t286 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t283;
            double t287 = t285+t286;
            double t288 = t106*t108*t287*6.0;
            double t289 = t285+t286+t288;
            double t290 = t285+t286-cw2*t289;
            double t292 = cw1*t151*t265;
            double t293 = t292-cw1*t110*t111*t139*t163*t164*t265;
            double t294 = t4*t28*t35*t59*t150*t293;
            double t295 = t4*t26*t44*(1.0/1.0E1);
            double t296 = c*t4*t26*t44;
            double t297 = b*mu[i]*t3*t26*t27*t28*t34*t58*t59*t67*t88*t117*t123;
            double t299 = t4*t26*t44*t92*(9.0/1.0E1);
            double t298 = t295+t296+t297-t299;
            double t300 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t298;
            double t301 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t298;
            double t302 = t300+t301;
            double t303 = t106*t108*t302*6.0;
            double t304 = t300+t301+t303;
            double t324 = cw2*t304;
            double t305 = t300+t301-t324;
            double t306 = t3*t22*u2*2.0;
            double t307 = t3*t26*u3*2.0;
            double t308 = t306+t307;
            double t309 = t44*t308*(1.0/2.0E1);
            double t310 = c*t44*t308*(1.0/2.0);
            double t311 = b*mu[i]*t4*t27*t28*t34*t58*t59*t67*t88*t117*t123*t308*(1.0/2.0);
            double t313 = t44*t92*t308*(9.0/2.0E1);
            double t312 = t309+t310+t311-t313;
            double t314 = mu[i]*t4*t28*t34*t58*t59*t104*t126*t312;
            double t315 = b*mu[i]*t4*t27*t28*t34*t58*t59*t98*t126*t137*t312;
            double t316 = t314+t315;
            double t317 = t106*t108*t316*6.0;
            double t318 = t314+t315+t317;
            double t319 = t314+t315-cw2*t318;
            double t321 = cw1*t151*t276;
            double t322 = t321-cw1*t110*t111*t139*t163*t164*t276;
            double t323 = t4*t28*t35*t59*t150*t322;
            double t325 = cw1*t151*t305;
            double t326 = t325-cw1*t110*t111*t139*t163*t164*t305;
            double t327 = t4*t28*t35*t59*t150*t326;

            s_udg[0*ng+i] = 0.0;
            s_udg[1*ng+i] = 0.0;
            s_udg[2*ng+i] = 0.0;
            s_udg[3*ng+i] = 0.0;
            s_udg[4*ng+i] = 0.0;
            s_udg[5*ng+i] = (deltaU*deltaU)*ft1*param3+cb2*t28*t76*(t3*t78+t3*t80+t3*t82)+cb1*mu[i]*t34*t124*t152-cb2*t28*t76*u1*(t10*t78*2.0+t10*t80*2.0+t10*t82*2.0-t2*t83*u6*u7*2.0-t5*t83*u6*u13*2.0-t6*t83*u6*u19*2.0)+mu[i]*t3*t28*t76*t149*t214-t3*t28*t35*t59*t150*t240+t4*t28*t35*t59*t150*(cw1*t148*t151-cw1*t110*t111*t139*t148*t163*t164)+mu[i]*t4*t28*t76*t149*(t2*t3*u7+t3*t5*u13+t3*t6*u19-t10*t235*u6-t10*t236*u6-t10*t237*u6);
            s_udg[6*ng+i] = 0.0;
            s_udg[7*ng+i] = 0.0;
            s_udg[8*ng+i] = 0.0;
            s_udg[9*ng+i] = 0.0;
            s_udg[10*ng+i] = 0.0;
            s_udg[11*ng+i] = -cb1*mu[i]*t34*t152*t159+t4*t28*t35*t59*t150*(cw1*t151*t168-cw1*t110*t111*t139*t163*t164*t168);
            s_udg[12*ng+i] = 0.0;
            s_udg[13*ng+i] = 0.0;
            s_udg[14*ng+i] = 0.0;
            s_udg[15*ng+i] = 0.0;
            s_udg[16*ng+i] = 0.0;
            s_udg[17*ng+i] = cb1*mu[i]*t34*t152*t175-t4*t28*t35*t59*t150*(cw1*t151*t182-cw1*t110*t111*t139*t163*t164*t182);
            s_udg[18*ng+i] = 0.0;
            s_udg[19*ng+i] = 0.0;
            s_udg[20*ng+i] = 0.0;
            s_udg[21*ng+i] = 0.0;
            s_udg[22*ng+i] = 0.0;
            s_udg[23*ng+i] = cb1*mu[i]*t34*t152*t189-t4*t28*t35*t59*t150*(cw1*t151*t196-cw1*t110*t111*t139*t163*t164*t196);
            s_udg[24*ng+i] = 0.0;
            s_udg[25*ng+i] = 0.0;
            s_udg[26*ng+i] = 0.0;
            s_udg[27*ng+i] = 0.0;
            s_udg[28*ng+i] = 0.0;
            s_udg[29*ng+i] = 0.0;
            s_udg[30*ng+i] = 0.0;
            s_udg[31*ng+i] = 0.0;
            s_udg[32*ng+i] = 0.0;
            s_udg[33*ng+i] = 0.0;
            s_udg[34*ng+i] = 0.0;
            s_udg[35*ng+i] = -cb1*mu[i]*t34*t152*t224-cb1*mu[i]*t96*t152*t204-cb2*t28*t76*u1*(t2*t10*u7*2.0+t5*t10*u13*2.0+t6*t10*u19*2.0)-mu[i]*t4*t28*t76*t204*t214-t4*t28*t35*t59*t150*(cw1*t151*t234-cw1*t110*t111*t139*t163*t164*t234)+mu[i]*t4*t28*t76*t149*(t3*t235+t3*t236+t3*t237)+t4*t28*t34*t59*t150*t204*t240*2.0;
            s_udg[36*ng+i] = 0.0;
            s_udg[37*ng+i] = 0.0;
            s_udg[38*ng+i] = 0.0;
            s_udg[39*ng+i] = 0.0;
            s_udg[40*ng+i] = 0.0;
            s_udg[41*ng+i] = cb1*mu[i]*t34*t152*t247-mu[i]*t4*t28*t76*t149*(t2*t4-t3*u6*u7)-cb2*t2*t3*t28*t76*u6*2.0-t4*t28*t35*t59*t150*(cw1*t151*t254-cw1*t110*t111*t139*t163*t164*t254);
            s_udg[42*ng+i] = 0.0;
            s_udg[43*ng+i] = 0.0;
            s_udg[44*ng+i] = 0.0;
            s_udg[45*ng+i] = 0.0;
            s_udg[46*ng+i] = 0.0;
            s_udg[47*ng+i] = 0.0;
            s_udg[48*ng+i] = 0.0;
            s_udg[49*ng+i] = 0.0;
            s_udg[50*ng+i] = 0.0;
            s_udg[51*ng+i] = 0.0;
            s_udg[52*ng+i] = 0.0;
            s_udg[53*ng+i] = t294-cb1*mu[i]*t34*t152*t258;
            s_udg[54*ng+i] = 0.0;
            s_udg[55*ng+i] = 0.0;
            s_udg[56*ng+i] = 0.0;
            s_udg[57*ng+i] = 0.0;
            s_udg[58*ng+i] = 0.0;
            s_udg[59*ng+i] = t323-cb1*mu[i]*t34*t152*t269;
            s_udg[60*ng+i] = 0.0;
            s_udg[61*ng+i] = 0.0;
            s_udg[62*ng+i] = 0.0;
            s_udg[63*ng+i] = 0.0;
            s_udg[64*ng+i] = 0.0;
            s_udg[65*ng+i] = 0.0;
            s_udg[66*ng+i] = 0.0;
            s_udg[67*ng+i] = 0.0;
            s_udg[68*ng+i] = 0.0;
            s_udg[69*ng+i] = 0.0;
            s_udg[70*ng+i] = 0.0;
            s_udg[71*ng+i] = cb2*t4*t28*t76*(u12*2.0-t4*u6*u7*2.0)-mu[i]*t3*t28*t76*t149*u7;
            s_udg[72*ng+i] = 0.0;
            s_udg[73*ng+i] = 0.0;
            s_udg[74*ng+i] = 0.0;
            s_udg[75*ng+i] = 0.0;
            s_udg[76*ng+i] = 0.0;
            s_udg[77*ng+i] = -cb1*mu[i]*t34*t152*t283-mu[i]*t4*t28*t76*t149*(t4*t5-t3*u6*u13)-cb2*t3*t5*t28*t76*u6*2.0+t4*t28*t35*t59*t150*(cw1*t151*t290-cw1*t110*t111*t139*t163*t164*t290);
            s_udg[78*ng+i] = 0.0;
            s_udg[79*ng+i] = 0.0;
            s_udg[80*ng+i] = 0.0;
            s_udg[81*ng+i] = 0.0;
            s_udg[82*ng+i] = 0.0;
            s_udg[83*ng+i] = -t294+cb1*mu[i]*t34*t152*t258;
            s_udg[84*ng+i] = 0.0;
            s_udg[85*ng+i] = 0.0;
            s_udg[86*ng+i] = 0.0;
            s_udg[87*ng+i] = 0.0;
            s_udg[88*ng+i] = 0.0;
            s_udg[89*ng+i] = 0.0;
            s_udg[90*ng+i] = 0.0;
            s_udg[91*ng+i] = 0.0;
            s_udg[92*ng+i] = 0.0;
            s_udg[93*ng+i] = 0.0;
            s_udg[94*ng+i] = 0.0;
            s_udg[95*ng+i] = t327-cb1*mu[i]*t34*t152*t298;
            s_udg[96*ng+i] = 0.0;
            s_udg[97*ng+i] = 0.0;
            s_udg[98*ng+i] = 0.0;
            s_udg[99*ng+i] = 0.0;
            s_udg[100*ng+i] = 0.0;
            s_udg[101*ng+i] = 0.0;
            s_udg[102*ng+i] = 0.0;
            s_udg[103*ng+i] = 0.0;
            s_udg[104*ng+i] = 0.0;
            s_udg[105*ng+i] = 0.0;
            s_udg[106*ng+i] = 0.0;
            s_udg[107*ng+i] = cb2*t4*t28*t76*(u18*2.0-t4*u6*u13*2.0)-mu[i]*t3*t28*t76*t149*u13;
            s_udg[108*ng+i] = 0.0;
            s_udg[109*ng+i] = 0.0;
            s_udg[110*ng+i] = 0.0;
            s_udg[111*ng+i] = 0.0;
            s_udg[112*ng+i] = 0.0;
            s_udg[113*ng+i] = -cb1*mu[i]*t34*t152*t312-mu[i]*t4*t28*t76*t149*(t4*t6-t3*u6*u19)-cb2*t3*t6*t28*t76*u6*2.0+t4*t28*t35*t59*t150*(cw1*t151*t319-cw1*t110*t111*t139*t163*t164*t319);
            s_udg[114*ng+i] = 0.0;
            s_udg[115*ng+i] = 0.0;
            s_udg[116*ng+i] = 0.0;
            s_udg[117*ng+i] = 0.0;
            s_udg[118*ng+i] = 0.0;
            s_udg[119*ng+i] = -t323+cb1*mu[i]*t34*t152*t269;
            s_udg[120*ng+i] = 0.0;
            s_udg[121*ng+i] = 0.0;
            s_udg[122*ng+i] = 0.0;
            s_udg[123*ng+i] = 0.0;
            s_udg[124*ng+i] = 0.0;
            s_udg[125*ng+i] = -t327+cb1*mu[i]*t34*t152*t298;
            s_udg[126*ng+i] = 0.0;
            s_udg[127*ng+i] = 0.0;
            s_udg[128*ng+i] = 0.0;
            s_udg[129*ng+i] = 0.0;
            s_udg[130*ng+i] = 0.0;
            s_udg[131*ng+i] = 0.0;
            s_udg[132*ng+i] = 0.0;
            s_udg[133*ng+i] = 0.0;
            s_udg[134*ng+i] = 0.0;
            s_udg[135*ng+i] = 0.0;
            s_udg[136*ng+i] = 0.0;
            s_udg[137*ng+i] = 0.0;
            s_udg[138*ng+i] = 0.0;
            s_udg[139*ng+i] = 0.0;
            s_udg[140*ng+i] = 0.0;
            s_udg[141*ng+i] = 0.0;
            s_udg[142*ng+i] = 0.0;
            s_udg[143*ng+i] = cb2*t4*t28*t76*(u24*2.0-t4*u6*u19*2.0)-mu[i]*t3*t28*t76*t149*u19;
        }

        if (app.viscosityModel != 0) {

            for (int i = 0; i <ng; i++) {
                double x1 = pg[0*ng+i];
                double x2 = pg[1*ng+i];
                double x3 = pg[2*ng+i];

                double wallDistance = pg[4*ng+i];

                double u1 = udg[0*ng+i];
                double u2 = udg[1*ng+i];
                double u3 = udg[2*ng+i];
                double u4 = udg[3*ng+i];
                double u5 = udg[4*ng+i];
                double u6 = udg[5*ng+i];
                double u7 = udg[6*ng+i];
                double u8 = udg[7*ng+i];
                double u9 = udg[8*ng+i];
                double u10 = udg[9*ng+i];
                double u11 = udg[10*ng+i];
                double u12 = udg[11*ng+i];
                double u13 = udg[12*ng+i];
                double u14 = udg[13*ng+i];
                double u15 = udg[14*ng+i];
                double u16 = udg[15*ng+i];
                double u17 = udg[16*ng+i];
                double u18 = udg[17*ng+i];
                double u19 = udg[18*ng+i];
                double u20 = udg[19*ng+i];
                double u21 = udg[20*ng+i];
                double u22 = udg[21*ng+i];
                double u23 = udg[22*ng+i];
                double u24 = udg[23*ng+i];

                double t2 = 1.0/mu[i];
                double t3 = 1.0/u1;
                double t7 = t3*u3*u7;
                double t8 = t7-u9;
                double t9 = t3*t8;
                double t10 = t3*u2*u13;
                double t11 = t3*(t10-u14);
                double t4 = -t9+t11;
                double t13 = t3*u4*u7;
                double t14 = t13-u10;
                double t15 = t3*t14;
                double t16 = t3*u2*u19;
                double t17 = t3*(t16-u20);
                double t5 = -t15+t17;
                double t19 = t3*u4*u13;
                double t20 = t19-u16;
                double t21 = t3*t20;
                double t22 = t3*u3*u19;
                double t23 = t3*(t22-u21);
                double t6 = -t21+t23;
                double t12 = t4*t4;
                double t18 = t5*t5;
                double t24 = t6*t6;
                double t25 = t12+t18+t24+1.0E-20;
                double t26 = sqrt(t25);
                double t27 = 1.0/3.141592653589793;
                double t28 = b*t2*u6;
                double t29 = atan(t28);
                double t30 = t27*t29;
                double t31 = t30+1.0/2.0;
                double t32 = t2*t31*u6;
                double t33 = c+t32;
                double t34 = t33*t33;
                double t35 = cv1*cv1;
                double t36 = 1.0/(kappa*kappa);
                double t37 = 1.0/param3;
                double t38 = 1.0/(wallDistance*wallDistance);
                double t39 = t34*t34;
                double t40 = cv1*t35+t33*t34;
                double t41 = 1.0/t40;
                double t42 = t39*t41;
                double t43 = t42+1.0;
                double t44 = 1.0/t43;
                double t45 = t33*t44;
                double t46 = t45-1.0;
                double t47 = 1.0/(mu[i]*mu[i]);
                double t48 = u6*u6;
                double t49 = ft2-1.0;
                double t50 = c*t26;
                double t51 = t26*(1.0/1.0E1);
                double t52 = t26*(9.0/1.0E1);
                double t70 = mu[i]*t3*t33*t36*t37*t38*t46;
                double t53 = t52-t70;
                double t54 = 1.0/sqrt(t25);
                double t55 = mu[i]*t3*t33*t36*t37*t38*t46*t54;
                double t56 = t55-9.0/1.0E1;
                double t57 = b*t56;
                double t58 = atan(t57);
                double t59 = t27*t58;
                double t60 = t59-1.0/2.0;
                double t79 = t53*t60;
                double t61 = t50+t51-t79;
                double t62 = t31*t47*u6;
                double t63 = 1.0/(mu[i]*mu[i]*mu[i]);
                double t64 = b*b;
                double t65 = t47*t48*t64;
                double t66 = t65+1.0;
                double t67 = 1.0/t66;
                double t68 = b*t27*t48*t63*t67;
                double t69 = t62+t68;
                double t71 = t44*t69;
                double t72 = t33*t34*t41*t69*4.0;
                double t73 = 1.0/(t40*t40);
                double t95 = t34*t39*t69*t73*3.0;
                double t74 = t72-t95;
                double t75 = 1.0/(t43*t43);
                double t96 = t33*t74*t75;
                double t76 = t71-t96;
                double t77 = cw3*cw3;
                double t78 = t77*t77;
                double t80 = 1.0/t61;
                double t82 = mu[i]*t3*t33*t36*t37*t38*t80;
                double t81 = rMax-t82;
                double t83 = b*t81;
                double t84 = atan(t83);
                double t85 = t27*t84;
                double t86 = t85+1.0/2.0;
                double t87 = t81*t86;
                double t88 = c-rMax+t87;
                double t89 = t88*t88;
                double t90 = t89*t89;
                double t123 = c-rMax+t87+t89*t90;
                double t124 = cw2*t123;
                double t91 = c-rMax+t87-t124;
                double t92 = t91*t91;
                double t93 = t92*t92;
                double t94 = mu[i]*t3*t36*t37*t38*t46*t69;
                double t97 = mu[i]*t3*t33*t36*t37*t38*t76;
                double t109 = t3*t33*t36*t37*t38*t46;
                double t98 = t94+t97-t109;
                double t99 = t60*t98;
                double t100 = t56*t56;
                double t101 = t64*t100;
                double t102 = t101+1.0;
                double t103 = 1.0/t102;
                double t104 = mu[i]*t3*t33*t36*t37*t38*t54*t76;
                double t105 = mu[i]*t3*t36*t37*t38*t46*t54*t69;
                double t110 = t3*t33*t36*t37*t38*t46*t54;
                double t106 = t104+t105-t110;
                double t111 = b*t27*t53*t103*t106;
                double t107 = t99-t111;
                double t108 = t3*t33*t36*t37*t38*t80;
                double t112 = 1.0/(t61*t61);
                double t113 = mu[i]*t3*t33*t36*t37*t38*t107*t112;
                double t115 = mu[i]*t3*t36*t37*t38*t69*t80;
                double t114 = t108+t113-t115;
                double t116 = t86*t114;
                double t117 = t81*t81;
                double t118 = t64*t117;
                double t119 = t118+1.0;
                double t120 = 1.0/t119;
                double t121 = b*t27*t81*t114*t120;
                double t122 = t77*t78+1.0;
                double t125 = t77*t78+t92*t93;
                double t126 = 1.0/t125;
                double t127 = t122*t126;
                double t128 = t116+t121;
                double t129 = t88*t90*t128*6.0;
                double t130 = t116+t121+t129;
                double t131 = t116+t121-cw2*t130;
                double t132 = pow(t127,1.0/6.0);
                double t133 = 1.0/sigma;
                double t134 = u12-t3*u6*u7;
                double t135 = t3*t134*u7;
                double t136 = u18-t3*u6*u13;
                double t137 = t3*t136*u13;
                double t138 = u24-t3*u6*u19;
                double t139 = t3*t138*u19;
                double t140 = t135+t137+t139;
                double t141 = mu[i]*mu[i];
                double t142 = cw1*t91*t132;
                double t143 = cb1*ft2*t36;
                double t144 = t142+t143;

                s_mu[0*ng+i] = 0.0;
                s_mu[1*ng+i] = 0.0;
                s_mu[2*ng+i] = 0.0;
                s_mu[3*ng+i] = 0.0;
                s_mu[4*ng+i] = 0.0;
                s_mu[5*ng+i] = -cb1*t33*t49*t61-t3*t37*t133*t140*(c+t32+1.0)+cb1*mu[i]*t49*t61*t69+cb1*mu[i]*t33*t49*t107+mu[i]*t3*t34*t37*t38*t144*2.0+mu[i]*t3*t37*t69*t133*t140-t3*t34*t37*t38*t141*(cw1*t131*t132-cw1*t92*t93*t122*1.0/(t125*t125)*1.0/pow(t127,5.0/6.0)*t131)-t3*t33*t37*t38*t69*t141*t144*2.0;
            }

            chainRule_s_udg(s_udg, s_mu, mu_udg, ng, nc, ncu, nd);
        }
        
//         for (int i = 0; i <ng*6*24; i++) {
//             s_udg[i] /= param3;
//         }
    }

    /* Deallocate dynamic memory */
    delete[] mu;
    if (computeJacobian == 1 && app.viscosityModel != 0) {
        delete[] mu_udg;
        delete[] s_mu;
    }
}
