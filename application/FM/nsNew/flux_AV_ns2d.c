
// Written by C. Nguyen and P. Fernandez

void flux_AV_ns2d(double *f, double *f_udg, double *pg, double *udg, appstruct &app, double *param, double time, int ng, int nc, int ncu, int nd, int ncd, int computeJacobian)
{
    // Artificial viscosity fluxes. Latest version of the model.
    
	double rampFactor;
	double porder = (double) app.porder[0];
	double alpha = 100.0;
	double beta = 1.0e-2;
	double k_h = 1.5;
	double eps_v = 1.0e-8;

	double gam = param[0];
	double Minf = param[4];

	for (int i = 0; i <ng; i++) {
		double u1 = udg[0*ng+i];
		double u2 = udg[1*ng+i];
		double u3 = udg[2*ng+i];
		double u4 = udg[3*ng+i];
		double u5 = udg[4*ng+i];
		double u6 = udg[5*ng+i];
		double u7 = udg[6*ng+i];
		double u8 = udg[7*ng+i];
		double u9 = udg[8*ng+i];
		double u10 = udg[9*ng+i];
		double u11 = udg[10*ng+i];
		double u12 = udg[11*ng+i];

		double h = pg[2*ng+i];
		double wallDistance = pg[3*ng+i];
		//rampFactor = (1.0 - 1.0/(10.0*wallDistance+1.0)) * app.rampFactor;
        rampFactor = app.rampFactor;

		double r = u1;
		double ru = u2;
		double rv = u3;
		double rE = u4;
		double rx = u5;
		double rux = u6;
		double rvx = u7;
		double rEx = u8;
		double ry = u9;
		double ruy = u10;
		double rvy = u11;
		double rEy = u12;

		double u = ru/r;
		double v = rv/r;
		double ux = (rux - u*rx)/r;
		double vy = (rvy - v*ry)/r;

		double t2 = 1.0/porder;
		double t3 = 1.0/r;
		double t13 = ru*rx*t3;
		double t4 = rux-t13;
		double t5 = t3*t4;
		double t14 = rv*ry*t3;
		double t6 = rvy-t14;
		double t7 = t3*t6;
		double t8 = t5+t7;
		double t15 = h*k_h*t2*t8;
		double t9 = beta-t15;
		double t10 = 1.0/3.141592653589793;
		double t11 = 1.0/Minf;
		double t12 = t11+1.0;
		double t16 = alpha*t9;
		double t17 = atan(t16);
		double t18 = t10*t17;
		double t19 = t18-1.0/2.0;
		double t20 = t9*t19;
		double t21 = atan(alpha);
		double t23 = t10*t21;
		double t22 = t20-t23+1.0/2.0;
		double t24 = 1.0/(r*r);
		double t25 = gam*(1.0/2.0);
		double t26 = t25-1.0/2.0;
		double t27 = ru*ru;
		double t28 = rv*rv;

		f[0*ng+i] += h*k_h*rampFactor*rx*t2*t12*t22;
		f[1*ng+i] += h*k_h*rampFactor*rux*t2*t12*t22;
		f[2*ng+i] += h*k_h*rampFactor*rvx*t2*t12*t22;
		f[3*ng+i] += -h*k_h*rampFactor*t2*t12*t22*(t26*(ru*t3*t4*2.0+rx*t24*t27+rx*t24*t28+rv*t3*(rvx-rv*rx*t3)*2.0)-gam*rEx);
		f[4*ng+i] += h*k_h*rampFactor*ry*t2*t12*t22;
		f[5*ng+i] += h*k_h*rampFactor*ruy*t2*t12*t22;
		f[6*ng+i] += h*k_h*rampFactor*rvy*t2*t12*t22;
		f[7*ng+i] += -h*k_h*rampFactor*t2*t12*t22*(t26*(rv*t3*t6*2.0+ry*t24*t27+ry*t24*t28+ru*t3*(ruy-ru*ry*t3)*2.0)-gam*rEy);
	}

	if (computeJacobian == 1) {
		for (int i = 0; i <ng; i++) {
			double u1 = udg[0*ng+i];
			double u2 = udg[1*ng+i];
			double u3 = udg[2*ng+i];
			double u4 = udg[3*ng+i];
			double u5 = udg[4*ng+i];
			double u6 = udg[5*ng+i];
			double u7 = udg[6*ng+i];
			double u8 = udg[7*ng+i];
			double u9 = udg[8*ng+i];
			double u10 = udg[9*ng+i];
			double u11 = udg[10*ng+i];
			double u12 = udg[11*ng+i];

			double h = pg[2*ng+i];
			double wallDistance = pg[3*ng+i];
			rampFactor = (1.0 - 1.0/(10.0*wallDistance+1.0)) * app.rampFactor;

            double r = u1;
            double ru = u2;
            double rv = u3;
            double rE = u4;
            double rx = u5;
            double rux = u6;
            double rvx = u7;
            double rEx = u8;
            double ry = u9;
            double ruy = u10;
            double rvy = u11;
            double rEy = u12;

            double u = ru/r;
            double v = rv/r;
            double ux = (rux - u*rx)/r;
            double vy = (rvy - v*ry)/r;

			double t2 = 1.0/porder;
			double t3 = 1.0/r;
			double t9 = ru*rx*t3;
			double t4 = rux-t9;
			double t5 = 1.0/(r*r);
			double t11 = rv*ry*t3;
			double t6 = rvy-t11;
			double t7 = 1.0/(r*r*r);
			double t8 = 1.0/3.141592653589793;
			double t10 = t3*t4;
			double t12 = t3*t6;
			double t13 = t10+t12;
			double t15 = h*k_h*t2*t13;
			double t14 = beta-t15;
			double t16 = t4*t5;
			double t17 = t5*t6;
			double t25 = ru*rx*t7;
			double t26 = rv*ry*t7;
			double t18 = t16+t17-t25-t26;
			double t19 = 1.0/Minf;
			double t20 = t19+1.0;
			double t21 = alpha*t14;
			double t22 = atan(t21);
			double t23 = t8*t22;
			double t24 = t23-1.0/2.0;
			double t27 = h*k_h*t2*t18*t24;
			double t28 = alpha*alpha;
			double t29 = t14*t14;
			double t30 = t28*t29;
			double t31 = t30+1.0;
			double t32 = 1.0/t31;
			double t33 = alpha*h*k_h*t2*t8*t14*t18*t32;
			double t34 = t27+t33;
			double t35 = gam*(1.0/2.0);
			double t36 = t35-1.0/2.0;
			double t50 = rv*rx*t3;
			double t37 = rvx-t50;
			double t38 = ru*ru;
			double t39 = rv*rv;
			double t57 = ru*ry*t3;
			double t40 = ruy-t57;
			double t41 = t14*t24;
			double t42 = atan(alpha);
			double t54 = t8*t42;
			double t43 = t41-t54+1.0/2.0;
			double t44 = h*k_h*rx*t2*t5*t24;
			double t45 = alpha*h*k_h*rx*t2*t5*t8*t14*t32;
			double t46 = t44+t45;
			double t47 = rx*t5*t38;
			double t48 = rx*t5*t39;
			double t49 = ru*t3*t4*2.0;
			double t51 = rv*t3*t37*2.0;
			double t52 = t47+t48+t49+t51;
			double t65 = gam*rEx;
			double t66 = t36*t52;
			double t53 = t65-t66;
			double t55 = ry*t5*t38;
			double t56 = ry*t5*t39;
			double t58 = ru*t3*t40*2.0;
			double t59 = rv*t3*t6*2.0;
			double t60 = t55+t56+t58+t59;
			double t67 = gam*rEy;
			double t68 = t36*t60;
			double t61 = t67-t68;
			double t62 = h*k_h*ry*t2*t5*t24;
			double t63 = alpha*h*k_h*ry*t2*t5*t8*t14*t32;
			double t64 = t62+t63;
			double t69 = h*k_h*ru*t2*t5*t24;
			double t70 = alpha*h*k_h*ru*t2*t5*t8*t14*t32;
			double t71 = t69+t70;
			double t72 = h*k_h*rampFactor*t2*t20*t43;
			double t73 = h*k_h*t2*t3*t24;
			double t74 = alpha*h*k_h*t2*t3*t8*t14*t32;
			double t75 = t73+t74;
			double t76 = h*k_h*rv*t2*t5*t24;
			double t77 = alpha*h*k_h*rv*t2*t5*t8*t14*t32;
			double t78 = t76+t77;
			double t79 = t5*t38;
			double t80 = t5*t39;
			double t81 = t79+t80;
			double t82 = h*k_h*rampFactor*t2*t20*t36*t43*t81;
			double t83 = gam*h*k_h*rampFactor*t2*t20*t43;

			f_udg[0*ng+i] += h*k_h*rampFactor*rx*t2*t20*t34;
			f_udg[1*ng+i] += h*k_h*rampFactor*rux*t2*t20*t34;
			f_udg[2*ng+i] += h*k_h*rampFactor*rvx*t2*t20*t34;
			f_udg[3*ng+i] += h*k_h*rampFactor*t2*t20*t34*t53+h*k_h*rampFactor*t2*t20*t36*t43*(ru*t4*t5*2.0+rv*t5*t37*2.0);
			f_udg[4*ng+i] += h*k_h*rampFactor*ry*t2*t20*t34;
			f_udg[5*ng+i] += h*k_h*rampFactor*ruy*t2*t20*t34;
			f_udg[6*ng+i] += h*k_h*rampFactor*rvy*t2*t20*t34;
			f_udg[7*ng+i] += h*k_h*rampFactor*t2*t20*t34*t61+h*k_h*rampFactor*t2*t20*t36*t43*(ru*t5*t40*2.0+rv*t5*t6*2.0);
			f_udg[8*ng+i] += h*k_h*rampFactor*rx*t2*t20*t46;
			f_udg[9*ng+i] += h*k_h*rampFactor*rux*t2*t20*t46;
			f_udg[10*ng+i] += h*k_h*rampFactor*rvx*t2*t20*t46;
			f_udg[11*ng+i] += h*k_h*rampFactor*t2*t20*t46*t53-h*k_h*rampFactor*t2*t3*t4*t20*t36*t43*2.0;
			f_udg[12*ng+i] += h*k_h*rampFactor*ry*t2*t20*t46;
			f_udg[13*ng+i] += h*k_h*rampFactor*ruy*t2*t20*t46;
			f_udg[14*ng+i] += h*k_h*rampFactor*rvy*t2*t20*t46;
			f_udg[15*ng+i] += h*k_h*rampFactor*t2*t20*t46*t61-h*k_h*rampFactor*t2*t3*t20*t36*t40*t43*2.0;
			f_udg[16*ng+i] += h*k_h*rampFactor*rx*t2*t20*t64;
			f_udg[17*ng+i] += h*k_h*rampFactor*rux*t2*t20*t64;
			f_udg[18*ng+i] += h*k_h*rampFactor*rvx*t2*t20*t64;
			f_udg[19*ng+i] += h*k_h*rampFactor*t2*t20*t53*t64-h*k_h*rampFactor*t2*t3*t20*t36*t37*t43*2.0;
			f_udg[20*ng+i] += h*k_h*rampFactor*ry*t2*t20*t64;
			f_udg[21*ng+i] += h*k_h*rampFactor*ruy*t2*t20*t64;
			f_udg[22*ng+i] += h*k_h*rampFactor*rvy*t2*t20*t64;
			f_udg[23*ng+i] += h*k_h*rampFactor*t2*t20*t61*t64-h*k_h*rampFactor*t2*t3*t6*t20*t36*t43*2.0;
			f_udg[24*ng+i] += 0.0;
			f_udg[25*ng+i] += 0.0;
			f_udg[26*ng+i] += 0.0;
			f_udg[27*ng+i] += 0.0;
			f_udg[28*ng+i] += 0.0;
			f_udg[29*ng+i] += 0.0;
			f_udg[30*ng+i] += 0.0;
			f_udg[31*ng+i] += 0.0;
			f_udg[32*ng+i] += t72+h*k_h*rampFactor*rx*t2*t20*t71;
			f_udg[33*ng+i] += h*k_h*rampFactor*rux*t2*t20*t71;
			f_udg[34*ng+i] += h*k_h*rampFactor*rvx*t2*t20*t71;
			f_udg[35*ng+i] += t82+h*k_h*rampFactor*t2*t20*t53*t71;
			f_udg[36*ng+i] += h*k_h*rampFactor*ry*t2*t20*t71;
			f_udg[37*ng+i] += h*k_h*rampFactor*ruy*t2*t20*t71;
			f_udg[38*ng+i] += h*k_h*rampFactor*rvy*t2*t20*t71;
			f_udg[39*ng+i] += h*k_h*rampFactor*t2*t20*t61*t71;
			f_udg[40*ng+i] += -h*k_h*rampFactor*rx*t2*t20*t75;
			f_udg[41*ng+i] += t72-h*k_h*rampFactor*rux*t2*t20*t75;
			f_udg[42*ng+i] += -h*k_h*rampFactor*rvx*t2*t20*t75;
			f_udg[43*ng+i] += -h*k_h*rampFactor*t2*t20*t53*t75-h*k_h*rampFactor*ru*t2*t3*t20*t36*t43*2.0;
			f_udg[44*ng+i] += -h*k_h*rampFactor*ry*t2*t20*t75;
			f_udg[45*ng+i] += -h*k_h*rampFactor*ruy*t2*t20*t75;
			f_udg[46*ng+i] += -h*k_h*rampFactor*rvy*t2*t20*t75;
			f_udg[47*ng+i] += -h*k_h*rampFactor*t2*t20*t61*t75;
			f_udg[48*ng+i] += 0.0;
			f_udg[49*ng+i] += 0.0;
			f_udg[50*ng+i] += t72;
			f_udg[51*ng+i] += h*k_h*rampFactor*rv*t2*t3*t20*t36*t43*-2.0;
			f_udg[52*ng+i] += 0.0;
			f_udg[53*ng+i] += 0.0;
			f_udg[54*ng+i] += 0.0;
			f_udg[55*ng+i] += 0.0;
			f_udg[56*ng+i] += 0.0;
			f_udg[57*ng+i] += 0.0;
			f_udg[58*ng+i] += 0.0;
			f_udg[59*ng+i] += t83;
			f_udg[60*ng+i] += 0.0;
			f_udg[61*ng+i] += 0.0;
			f_udg[62*ng+i] += 0.0;
			f_udg[63*ng+i] += 0.0;
			f_udg[64*ng+i] += h*k_h*rampFactor*rx*t2*t20*t78;
			f_udg[65*ng+i] += h*k_h*rampFactor*rux*t2*t20*t78;
			f_udg[66*ng+i] += h*k_h*rampFactor*rvx*t2*t20*t78;
			f_udg[67*ng+i] += h*k_h*rampFactor*t2*t20*t53*t78;
			f_udg[68*ng+i] += t72+h*k_h*rampFactor*ry*t2*t20*t78;
			f_udg[69*ng+i] += h*k_h*rampFactor*ruy*t2*t20*t78;
			f_udg[70*ng+i] += h*k_h*rampFactor*rvy*t2*t20*t78;
			f_udg[71*ng+i] += t82+h*k_h*rampFactor*t2*t20*t61*t78;
			f_udg[72*ng+i] += 0.0;
			f_udg[73*ng+i] += 0.0;
			f_udg[74*ng+i] += 0.0;
			f_udg[75*ng+i] += 0.0;
			f_udg[76*ng+i] += 0.0;
			f_udg[77*ng+i] += t72;
			f_udg[78*ng+i] += 0.0;
			f_udg[79*ng+i] += h*k_h*rampFactor*ru*t2*t3*t20*t36*t43*-2.0;
			f_udg[80*ng+i] += -h*k_h*rampFactor*rx*t2*t20*t75;
			f_udg[81*ng+i] += -h*k_h*rampFactor*rux*t2*t20*t75;
			f_udg[82*ng+i] += -h*k_h*rampFactor*rvx*t2*t20*t75;
			f_udg[83*ng+i] += -h*k_h*rampFactor*t2*t20*t53*t75;
			f_udg[84*ng+i] += -h*k_h*rampFactor*ry*t2*t20*t75;
			f_udg[85*ng+i] += -h*k_h*rampFactor*ruy*t2*t20*t75;
			f_udg[86*ng+i] += t72-h*k_h*rampFactor*rvy*t2*t20*t75;
			f_udg[87*ng+i] += -h*k_h*rampFactor*t2*t20*t61*t75-h*k_h*rampFactor*rv*t2*t3*t20*t36*t43*2.0;
			f_udg[88*ng+i] += 0.0;
			f_udg[89*ng+i] += 0.0;
			f_udg[90*ng+i] += 0.0;
			f_udg[91*ng+i] += 0.0;
			f_udg[92*ng+i] += 0.0;
			f_udg[93*ng+i] += 0.0;
			f_udg[94*ng+i] += 0.0;
			f_udg[95*ng+i] += t83;
		}
	}
}
