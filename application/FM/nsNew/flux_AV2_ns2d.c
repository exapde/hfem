
// Written by C. Nguyen and P. Fernandez

void flux_AV2_ns2d(double *f, double *f_udg, double *pg, double *udg, appstruct &app, double *param, double time, int ng, int nc, int ncu, int nd, int ncd, int computeJacobian)
{
		
	double rampFactor;
	double alpha = 100.0;
	double epsilon0 = 0.005;

	double gam = param[0];

	for (int i = 0; i <ng; i++) {
		double u1 = udg[0*ng+i];
		double u2 = udg[1*ng+i];
		double u3 = udg[2*ng+i];
		double u4 = udg[3*ng+i];
		double u5 = udg[4*ng+i];
		double u6 = udg[5*ng+i];
		double u7 = udg[6*ng+i];
		double u8 = udg[7*ng+i];
		double u9 = udg[8*ng+i];
		double u10 = udg[9*ng+i];
		double u11 = udg[10*ng+i];
		double u12 = udg[11*ng+i];

		double h = pg[2*ng+i];
		double wallDistance = pg[3*ng+i];
		// rampFactor = (1.0 - 1.0/(10.0*wallDistance+1.0)) * app.rampFactor;
		rampFactor = app.rampFactor;

		double r = u1;
		double ru = u2;
		double rv = u3;
		double rE = u4;
		double rx = u5;
		double rux = u6;
		double rvx = u7;
		double rEx = u8;
		double ry = u9;
		double ruy = u10;
		double rvy = u11;
		double rEy = u12;

		double u = ru/r;
		double v = rv/r;
		double ux = (rux - u*rx)/r;
		double vy = (rvy - v*ry)/r;

		double t2 = 1.0/3.141592653589793;
		double t3 = 1.0/r;
		double t10 = ru*rx*t3;
		double t4 = rux-t10;
		double t5 = t3*t4;
		double t11 = rv*ry*t3;
		double t6 = rvy-t11;
		double t7 = t3*t6;
		double t8 = t5+t7;
		double t9 = atan(alpha);
		double t12 = alpha*h*t8;
		double t13 = atan(t12);
		double t14 = t2*t13;
		double t15 = t14+1.0/2.0;
		double t16 = h*t8*t15;
		double t18 = t2*t9;
		double t17 = t16-t18+1.0/2.0;
		double t19 = 1.0/(r*r);
		double t20 = gam*(1.0/2.0);
		double t21 = t20-1.0/2.0;
		double t22 = ru*ru;
		double t23 = rv*rv;

		f[0*ng+i] += epsilon0*rampFactor*rx*t17;
		f[1*ng+i] += epsilon0*rampFactor*rux*t17;
		f[2*ng+i] += epsilon0*rampFactor*rvx*t17;
		f[3*ng+i] += -epsilon0*rampFactor*t17*(t21*(ru*t3*t4*2.0+rx*t19*t22+rx*t19*t23+rv*t3*(rvx-rv*rx*t3)*2.0)-gam*rEx);
		f[4*ng+i] += epsilon0*rampFactor*ry*t17;
		f[5*ng+i] += epsilon0*rampFactor*ruy*t17;
		f[6*ng+i] += epsilon0*rampFactor*rvy*t17;
		f[7*ng+i] += -epsilon0*rampFactor*t17*(t21*(rv*t3*t6*2.0+ry*t19*t22+ry*t19*t23+ru*t3*(ruy-ru*ry*t3)*2.0)-gam*rEy);
	}

	if (computeJacobian == 1) {
		for (int i = 0; i <ng; i++) {
			double u1 = udg[0*ng+i];
			double u2 = udg[1*ng+i];
			double u3 = udg[2*ng+i];
			double u4 = udg[3*ng+i];
			double u5 = udg[4*ng+i];
			double u6 = udg[5*ng+i];
			double u7 = udg[6*ng+i];
			double u8 = udg[7*ng+i];
			double u9 = udg[8*ng+i];
			double u10 = udg[9*ng+i];
			double u11 = udg[10*ng+i];
			double u12 = udg[11*ng+i];

			double h = pg[2*ng+i];
			double wallDistance = pg[3*ng+i];
//			rampFactor = (1.0 - 1.0/(10.0*wallDistance+1.0)) * app.rampFactor;
			rampFactor = app.rampFactor;

			double r = u1;
			double ru = u2;
			double rv = u3;
			double rE = u4;
			double rx = u5;
			double rux = u6;
			double rvx = u7;
			double rEx = u8;
			double ry = u9;
			double ruy = u10;
			double rvy = u11;
			double rEy = u12;

			double u = ru/r;
			double v = rv/r;
			double ux = (rux - u*rx)/r;
			double vy = (rvy - v*ry)/r;

			double t2 = 1.0/r;
			double t9 = ru*rx*t2;
			double t3 = rux-t9;
			double t4 = 1.0/(r*r);
			double t11 = rv*ry*t2;
			double t5 = rvy-t11;
			double t6 = 1.0/(r*r*r);
			double t7 = 1.0/3.141592653589793;
			double t8 = h*h;
			double t10 = t2*t3;
			double t12 = t2*t5;
			double t13 = t10+t12;
			double t14 = t3*t4;
			double t15 = t4*t5;
			double t21 = ru*rx*t6;
			double t22 = rv*ry*t6;
			double t16 = t14+t15-t21-t22;
			double t17 = alpha*h*t13;
			double t18 = atan(t17);
			double t19 = t7*t18;
			double t20 = t19+1.0/2.0;
			double t23 = h*t16*t20;
			double t24 = alpha*alpha;
			double t25 = t13*t13;
			double t26 = t8*t24*t25;
			double t27 = t26+1.0;
			double t28 = 1.0/t27;
			double t29 = alpha*t7*t8*t13*t16*t28;
			double t30 = t23+t29;
			double t31 = gam*(1.0/2.0);
			double t32 = t31-1.0/2.0;
			double t46 = rv*rx*t2;
			double t33 = rvx-t46;
			double t34 = ru*ru;
			double t35 = rv*rv;
			double t53 = ru*ry*t2;
			double t36 = ruy-t53;
			double t37 = atan(alpha);
			double t38 = h*t13*t20;
			double t50 = t7*t37;
			double t39 = t38-t50+1.0/2.0;
			double t40 = h*rx*t4*t20;
			double t41 = alpha*rx*t4*t7*t8*t13*t28;
			double t42 = t40+t41;
			double t43 = rx*t4*t34;
			double t44 = rx*t4*t35;
			double t45 = ru*t2*t3*2.0;
			double t47 = rv*t2*t33*2.0;
			double t48 = t43+t44+t45+t47;
			double t61 = gam*rEx;
			double t62 = t32*t48;
			double t49 = t61-t62;
			double t51 = ry*t4*t34;
			double t52 = ry*t4*t35;
			double t54 = ru*t2*t36*2.0;
			double t55 = rv*t2*t5*2.0;
			double t56 = t51+t52+t54+t55;
			double t63 = gam*rEy;
			double t64 = t32*t56;
			double t57 = t63-t64;
			double t58 = h*ry*t4*t20;
			double t59 = alpha*ry*t4*t7*t8*t13*t28;
			double t60 = t58+t59;
			double t65 = h*ru*t4*t20;
			double t66 = alpha*ru*t4*t7*t8*t13*t28;
			double t67 = t65+t66;
			double t68 = epsilon0*rampFactor*t39;
			double t69 = h*t2*t20;
			double t70 = alpha*t2*t7*t8*t13*t28;
			double t71 = t69+t70;
			double t72 = h*rv*t4*t20;
			double t73 = alpha*rv*t4*t7*t8*t13*t28;
			double t74 = t72+t73;
			double t75 = t4*t34;
			double t76 = t4*t35;
			double t77 = t75+t76;
			double t78 = epsilon0*rampFactor*t32*t39*t77;
			double t79 = epsilon0*rampFactor*rx*t71;
			double t80 = epsilon0*rampFactor*rux*t71;
			double t81 = epsilon0*rampFactor*rvx*t71;
			double t82 = epsilon0*rampFactor*t49*t71;
			double t83 = epsilon0*rampFactor*ry*t71;
			double t84 = epsilon0*rampFactor*ruy*t71;
			double t85 = epsilon0*rampFactor*rvy*t71;
			double t86 = epsilon0*rampFactor*t57*t71;
			double t87 = epsilon0*gam*rampFactor*t39;

			f_udg[0*ng+i] += -epsilon0*rampFactor*rx*t30;
			f_udg[1*ng+i] += -epsilon0*rampFactor*rux*t30;
			f_udg[2*ng+i] += -epsilon0*rampFactor*rvx*t30;
			f_udg[3*ng+i] += -epsilon0*rampFactor*t30*t49+epsilon0*rampFactor*t32*t39*(ru*t3*t4*2.0+rv*t4*t33*2.0);
			f_udg[4*ng+i] += -epsilon0*rampFactor*ry*t30;
			f_udg[5*ng+i] += -epsilon0*rampFactor*ruy*t30;
			f_udg[6*ng+i] += -epsilon0*rampFactor*rvy*t30;
			f_udg[7*ng+i] += -epsilon0*rampFactor*t30*t57+epsilon0*rampFactor*t32*t39*(ru*t4*t36*2.0+rv*t4*t5*2.0);
			f_udg[8*ng+i] += -epsilon0*rampFactor*rx*t42;
			f_udg[9*ng+i] += -epsilon0*rampFactor*rux*t42;
			f_udg[10*ng+i] += -epsilon0*rampFactor*rvx*t42;
			f_udg[11*ng+i] += -epsilon0*rampFactor*t42*t49-epsilon0*rampFactor*t2*t3*t32*t39*2.0;
			f_udg[12*ng+i] += -epsilon0*rampFactor*ry*t42;
			f_udg[13*ng+i] += -epsilon0*rampFactor*ruy*t42;
			f_udg[14*ng+i] += -epsilon0*rampFactor*rvy*t42;
			f_udg[15*ng+i] += -epsilon0*rampFactor*t42*t57-epsilon0*rampFactor*t2*t32*t36*t39*2.0;
			f_udg[16*ng+i] += -epsilon0*rampFactor*rx*t60;
			f_udg[17*ng+i] += -epsilon0*rampFactor*rux*t60;
			f_udg[18*ng+i] += -epsilon0*rampFactor*rvx*t60;
			f_udg[19*ng+i] += -epsilon0*rampFactor*t49*t60-epsilon0*rampFactor*t2*t32*t33*t39*2.0;
			f_udg[20*ng+i] += -epsilon0*rampFactor*ry*t60;
			f_udg[21*ng+i] += -epsilon0*rampFactor*ruy*t60;
			f_udg[22*ng+i] += -epsilon0*rampFactor*rvy*t60;
			f_udg[23*ng+i] += -epsilon0*rampFactor*t57*t60-epsilon0*rampFactor*t2*t5*t32*t39*2.0;
			f_udg[24*ng+i] += 0.0;
			f_udg[25*ng+i] += 0.0;
			f_udg[26*ng+i] += 0.0;
			f_udg[27*ng+i] += 0.0;
			f_udg[28*ng+i] += 0.0;
			f_udg[29*ng+i] += 0.0;
			f_udg[30*ng+i] += 0.0;
			f_udg[31*ng+i] += 0.0;
			f_udg[32*ng+i] += t68-epsilon0*rampFactor*rx*t67;
			f_udg[33*ng+i] += -epsilon0*rampFactor*rux*t67;
			f_udg[34*ng+i] += -epsilon0*rampFactor*rvx*t67;
			f_udg[35*ng+i] += t78-epsilon0*rampFactor*t49*t67;
			f_udg[36*ng+i] += -epsilon0*rampFactor*ry*t67;
			f_udg[37*ng+i] += -epsilon0*rampFactor*ruy*t67;
			f_udg[38*ng+i] += -epsilon0*rampFactor*rvy*t67;
			f_udg[39*ng+i] += -epsilon0*rampFactor*t57*t67;
			f_udg[40*ng+i] += t79;
			f_udg[41*ng+i] += t68+t80;
			f_udg[42*ng+i] += t81;
			f_udg[43*ng+i] += t82-epsilon0*rampFactor*ru*t2*t32*t39*2.0;
			f_udg[44*ng+i] += t83;
			f_udg[45*ng+i] += t84;
			f_udg[46*ng+i] += t85;
			f_udg[47*ng+i] += t86;
			f_udg[48*ng+i] += 0.0;
			f_udg[49*ng+i] += 0.0;
			f_udg[50*ng+i] += t68;
			f_udg[51*ng+i] += epsilon0*rampFactor*rv*t2*t32*t39*-2.0;
			f_udg[52*ng+i] += 0.0;
			f_udg[53*ng+i] += 0.0;
			f_udg[54*ng+i] += 0.0;
			f_udg[55*ng+i] += 0.0;
			f_udg[56*ng+i] += 0.0;
			f_udg[57*ng+i] += 0.0;
			f_udg[58*ng+i] += 0.0;
			f_udg[59*ng+i] += t87;
			f_udg[60*ng+i] += 0.0;
			f_udg[61*ng+i] += 0.0;
			f_udg[62*ng+i] += 0.0;
			f_udg[63*ng+i] += 0.0;
			f_udg[64*ng+i] += -epsilon0*rampFactor*rx*t74;
			f_udg[65*ng+i] += -epsilon0*rampFactor*rux*t74;
			f_udg[66*ng+i] += -epsilon0*rampFactor*rvx*t74;
			f_udg[67*ng+i] += -epsilon0*rampFactor*t49*t74;
			f_udg[68*ng+i] += t68-epsilon0*rampFactor*ry*t74;
			f_udg[69*ng+i] += -epsilon0*rampFactor*ruy*t74;
			f_udg[70*ng+i] += -epsilon0*rampFactor*rvy*t74;
			f_udg[71*ng+i] += t78-epsilon0*rampFactor*t57*t74;
			f_udg[72*ng+i] += 0.0;
			f_udg[73*ng+i] += 0.0;
			f_udg[74*ng+i] += 0.0;
			f_udg[75*ng+i] += 0.0;
			f_udg[76*ng+i] += 0.0;
			f_udg[77*ng+i] += t68;
			f_udg[78*ng+i] += 0.0;
			f_udg[79*ng+i] += epsilon0*rampFactor*ru*t2*t32*t39*-2.0;
			f_udg[80*ng+i] += t79;
			f_udg[81*ng+i] += t80;
			f_udg[82*ng+i] += t81;
			f_udg[83*ng+i] += t82;
			f_udg[84*ng+i] += t83;
			f_udg[85*ng+i] += t84;
			f_udg[86*ng+i] += t68+t85;
			f_udg[87*ng+i] += t86-epsilon0*rampFactor*rv*t2*t32*t39*2.0;
			f_udg[88*ng+i] += 0.0;
			f_udg[89*ng+i] += 0.0;
			f_udg[90*ng+i] += 0.0;
			f_udg[91*ng+i] += 0.0;
			f_udg[92*ng+i] += 0.0;
			f_udg[93*ng+i] += 0.0;
			f_udg[94*ng+i] += 0.0;
			f_udg[95*ng+i] += t87;
		}
	}
}
